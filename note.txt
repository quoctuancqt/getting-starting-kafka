CREATE STREAM MQ2KAF_TOPIC_DATA("type" VARCHAR,"data" ARRAY<STRUCT<"modelNo" VARCHAR, "serialNo" VARCHAR, "onOff" VARCHAR, "batteryPercentage" INT, "speedSetting" VARCHAR>>, "gatewayNo" VARCHAR, "lastUpdatedDate" VARCHAR) 
WITH (KAFKA_TOPIC ='MQ2KAF_TOPIC', VALUE_FORMAT ='JSON');

CREATE STREAM KAFKA_DEVICE_TELEMETRIES WITH (VALUE_FORMAT='AVRO') AS
	SELECT 
    	EXPLODE("data")-> "serialNo" as "DeviceSerialNo",
        CAST(TO_JSON_STRING(EXPLODE("data")) AS VARCHAR) as "Data",
        EXPLODE("data")-> "onOff" as "Operation",
        FROM_UNIXTIME(ROWTIME) as "CreatedAt"
  	FROM  MQ2KAF_TOPIC_DATA
    WHERE "type" = 'telemetry'
EMIT CHANGES;

kafka-console-consumer --bootstrap-server localhost:9092 --topic MQ2KAF_TOPIC --from-beginning